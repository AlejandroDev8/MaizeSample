services:
  # Instala dependencias PHP en el volumen "vendor" (se ejecuta y termina)
  composer:
    image: composer:2
    working_dir: /app
    user: "0:0"
    volumes:
      - .:/app
      - vendor:/app/vendor
    command: >
      sh -lc "composer install --no-interaction --prefer-dist
      && chown -R 1000:1000 /app/vendor"

  # Instala dependencias JS en el volumen "node_modules" (se ejecuta y termina)
  npm:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    command: >
      sh -lc "
        if [ -f package-lock.json ]; then npm ci; else npm install; fi
      "

  # Vite dev server (HMR)
  vite:
    image: node:20-alpine
    working_dir: /app
    depends_on:
      npm:
        condition: service_completed_successfully
    environment:
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "5173:5173"
    volumes:
      - .:/app
      - node_modules:/app/node_modules
    command: >
      sh -lc "
        npm run dev -- --host 0.0.0.0 --port 5173
      "

  # Override del servicio app del docker-compose.yml base
  app:
    volumes:
      - .:/var/www/html
      - vendor:/var/www/html/vendor
      - app_storage:/var/www/html/storage
    environment:
      RUN_MIGRATIONS: "0"
      RUN_SEEDER: "0"
      RUN_INEGI: "0"
      INEGI_FRESH: "0"
      VITE_DEV_SERVER_URL: "http://localhost:5173"

volumes:
  vendor:
  node_modules:
  app_storage:
